/* =========================
   ÁCIDO–BASE
========================= */
function calcularAnionGapCorregido() {
  const na = num("na");
  const k = num("k");
  const cl = num("cl");
  const hco3 = num("hco3_ag");
  let alb = num("alb");

  const outId = "resultadoAnionGap";
  if (anyNaN([na, k, cl, hco3]) || na <= 0 || cl <= 0 || hco3 <= 0) {
    setText(outId, "Complete Na, K, Cl y HCO₃ con valores válidos");
    return;
  }

  if (!Number.isFinite(alb) || alb <= 0) alb = 4;

  const ag = (na + k) - (cl + hco3);
  const agCorr = ag + 2.5 * (4 - alb);

  if (!Number.isFinite(ag) || !Number.isFinite(agCorr)) {
    setText(outId, "No se pudo calcular el anion gap");
    return;
  }

  setHTML(outId, `<strong>AG:</strong> ${ag.toFixed(1)} mEq/L<br>
    <strong>AG corregido (ALB):</strong> ${agCorr.toFixed(1)} mEq/L`);

  trackEvent("calculate_corrected_anion_gap", {
    ag_meq_l: Number(ag.toFixed(1)),
    ag_corrected_meq_l: Number(agCorr.toFixed(1)),
    albumin_g_dl: alb,
  });
}

function calcularDeltaGap() {
  const agPaciente = num("agapp");
  const hco3Paciente = num("bicap");
  const AG_NORMAL = 12;
  const HCO3_NORMAL = 24;

  const outId = "resultadoDeltaGap";
  const interpId = "interpretacionDeltaGap";

  if (!Number.isFinite(agPaciente) || !Number.isFinite(hco3Paciente)) {
    setHTML(outId, "<strong>Δ/Δ:</strong> —");
    setHTML(interpId, "Complete <strong>Anion Gap</strong> y <strong>Bicarbonato</strong>.");
    return;
  }

  if (agPaciente <= 0 || hco3Paciente <= 0) {
    setHTML(outId, "<strong>Δ/Δ:</strong> No interpretable");
    setHTML(interpId, "Valores no fisiológicos.");
    return;
  }

  const deltaBicarb = HCO3_NORMAL - hco3Paciente;
  if (deltaBicarb <= 0) {
    setHTML(outId, "<strong>Δ/Δ:</strong> No interpretable");
    setHTML(interpId, "HCO₃ no disminuido.");
    return;
  }

  const deltaDelta = (agPaciente - AG_NORMAL) / deltaBicarb;
  if (!Number.isFinite(deltaDelta)) {
    setHTML(outId, "<strong>Δ/Δ:</strong> —");
    setHTML(interpId, "No se pudo calcular.");
    return;
  }

  const texto =
    deltaDelta < 1
      ? "Sugiere <strong>acidosis metabólica hiperclorémica</strong> asociada."
      : deltaDelta <= 2
        ? "<strong>Acidosis metabólica con anion gap aumentado PURA</strong>."
        : "Sugiere <strong>alcalosis metabólica</strong> asociada.";

  setHTML(outId, `<strong>Δ/Δ:</strong> ${deltaDelta.toFixed(2)}`);
  setHTML(interpId, texto);

  trackEvent("calculate_delta_delta", {
    delta_delta: Number(deltaDelta.toFixed(2)),
    ag_paciente_meq_l: agPaciente,
    hco3_paciente_meq_l: hco3Paciente,
  });
}

/* =========================
   ELECTROLITOS
========================= */
function calcularSodioCorregido() {
  const nas = num("nas");
  const glucs = num("glucs");
  const outId = "resultadoNaCorregido";

  if (!Number.isFinite(nas) || nas <= 0 || !Number.isFinite(glucs)) {
    setText(outId, "Complete sodio y glucosa con valores válidos");
    return;
  }

  const nac = nas + (glucs > 100 ? (1.6 * ((glucs - 100) / 100)) : 0);
  if (!Number.isFinite(nac)) {
    setText(outId, "No se pudo calcular el sodio corregido");
    return;
  }

  setHTML(outId, `<strong>Na corregido:</strong> ${nac.toFixed(1)} mEq/L`);
  trackEvent("calculate_corrected_sodium", {
    sodium_meq_l: nas,
    glucose_mg_dl: glucs,
    sodium_corrected_meq_l: Number(nac.toFixed(1)),
  });
}

function calcularCalcioCorregido() {
  const cas = num("cas");
  let albs = num("albs");
  const outId = "resultadoCaCorregido";

  if (!Number.isFinite(cas) || cas <= 0) {
    setText(outId, "Complete calcio con un valor válido");
    return;
  }
  if (!Number.isFinite(albs) || albs <= 0) albs = 4;

  const cac = cas + (0.8 * (4 - albs));
  if (!Number.isFinite(cac)) {
    setText(outId, "No se pudo calcular el calcio corregido");
    return;
  }

  setHTML(outId, `<strong>Ca corregido:</strong> ${cac.toFixed(2)} mg/dL`);
  trackEvent("calculate_corrected_calcium", {
    calcium_mg_dl: cas,
    albumin_g_dl: albs,
    calcium_corrected_mg_dl: Number(cac.toFixed(2)),
  });
}

